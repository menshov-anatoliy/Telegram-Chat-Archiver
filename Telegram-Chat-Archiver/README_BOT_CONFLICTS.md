# Telegram Chat Archiver - Устранение конфликтов Bot API

## Проблема

Ошибка: `Conflict: terminated by other getUpdates request; make sure that only one bot instance is running`

Эта ошибка возникает, когда несколько экземпляров приложения пытаются одновременно получать обновления от Telegram Bot API.

## Причины возникновения

1. **Множественные экземпляры приложения** - запущено несколько копий приложения
2. **Некорректная остановка** - предыдущий экземпляр не был корректно остановлен
3. **Отладка в IDE** - приложение запущено в Visual Studio и из командной строки одновременно
4. **Процессы-зомби** - висящие процессы .NET Host

## Решения

### 1. Проверка запущенных процессов

Используйте включенный скрипт `check_processes.bat`:

```cmd
# Запустите скрипт для проверки процессов
check_processes.bat
```

Или вручную через командную строку:

```cmd
# Найти все процессы приложения
tasklist | findstr "Telegram.HostedApp"
tasklist | findstr "dotnet"

# Завершить процесс по PID
taskkill /PID [номер_процесса] /F
```

### 2. Конфигурация приложения

В `appsettings.json` настройте:

```json
{
  "BotConfig": {
    "EnableManagementCommands": false,  // Отключить для продакшна
    "MaxPollingRetries": 2,             // Ограничить попытки
    "PollingRetryDelayMs": 10000,       // Увеличить задержку
    "AutoRestartOnConflict": false,     // Отключить автоперезапуск
    "DisableOnRepeatedConflicts": true, // Отключать при повторных конфликтах
    "MaxConflictsBeforeDisable": 3      // Максимум конфликтов
  }
}
```

### 3. Использование команд управления (если включены)

Если `EnableManagementCommands` = true, используйте команды:

- `/status` - проверить статус системы
- `/restart_bot` - перезапустить polling бота
- `/help` - список доступных команд

### 4. Мониторинг через API

Проверьте статус через HTTP API:

```
GET http://localhost:5000/api/monitoring/status
GET http://localhost:5000/api/monitoring/bot/status
```

### 5. Корректная остановка приложения

Всегда используйте `Ctrl+C` или корректную остановку сервиса, чтобы polling остановился корректно.

## Дополнительные рекомендации

### Для разработки:

1. **Отключите команды управления** в development:
   ```json
   "EnableManagementCommands": false
   ```

2. **Используйте разные токены** для разработки и продакшна

3. **Мониторьте логи** на предмет конфликтов:
   ```
   [ERR] Ошибка в Bot API: Конфликт с другим экземпляром бота
   ```

### Для продакшна:

1. **Используйте единственный экземпляр** приложения
2. **Настройте автозапуск** как Windows Service или через Docker
3. **Мониторьте health checks**:
   ```
   GET /health
   GET /health/ready
   ```

## Автоматическое восстановление

Приложение включает механизмы:

- **Автоматическая очистка pending updates** при запуске
- **Обнаружение конфликтов** и корректное логирование
- **Глобальная защита** от множественных экземпляров polling
- **Автоматический перезапуск** после разрешения конфликта (опционально)

## Если проблема сохраняется

1. Перезагрузите компьютер (крайняя мера)
2. Проверьте, что бот не используется в других приложениях
3. Создайте новый бот через @BotFather
4. Отключите Bot API полностью:
   ```json
   "EnableBotNotifications": false,
   "EnableManagementCommands": false
   ```

## Логирование

Все события записываются в:
- Консоль
- Файлы логов: `logs/telegram-archiver-*.log`

Ищите записи с:
- `[ERR]` для ошибок
- `Конфликт` для обнаружения конфликтов
- `Polling` для событий запуска/остановки